---
import "../styles/global.css";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>my14ers — snapshot</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

    <style>
      /* keep leaflet clean in snapshot */
      .leaflet-container { background: transparent; border-radius: 1rem; }
      .leaflet-control-container { display: none !important; } /* hide map UI */
      .leaflet-pane, .leaflet-tile-pane, .leaflet-map-pane { border-radius: 1rem; }
    </style>
  </head>

  <body class="min-h-screen bg-zinc-950 text-zinc-100">
    <!-- background -->
    <div class="pointer-events-none fixed inset-0 -z-10">
      <div class="bg-drift absolute inset-0 bg-[radial-gradient(circle_at_20%_10%,rgba(168,85,247,0.28),transparent_42%),radial-gradient(circle_at_80%_30%,rgba(34,211,238,0.18),transparent_48%),radial-gradient(circle_at_50%_90%,rgba(16,185,129,0.12),transparent_55%)]"></div>
      <div class="absolute inset-0 opacity-[0.08] [background-image:linear-gradient(rgba(255,255,255,0.08)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.08)_1px,transparent_1px)] [background-size:48px_48px]"></div>
      <div class="absolute inset-0 bg-gradient-to-b from-transparent via-zinc-950/20 to-zinc-950"></div>
    </div>

    <main class="mx-auto max-w-6xl px-6 py-8">
      <div class="flex items-center justify-between gap-3">
        <a href="/" class="text-sm text-zinc-300 hover:text-white">← Back</a>

        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 p-1 backdrop-blur">
            <button id="modeCount" class="snap-mode-btn rounded-xl px-3 py-2 text-xs text-zinc-100 hover:bg-white/10" aria-pressed="false">
              Count
            </button>
            <button id="modeMini" class="snap-mode-btn rounded-xl px-3 py-2 text-xs text-zinc-100 hover:bg-white/10" aria-pressed="true">
              Checklist
            </button>
            <button id="modeHide" class="snap-mode-btn rounded-xl px-3 py-2 text-xs text-zinc-100 hover:bg-white/10" aria-pressed="false">
              Hide
            </button>
          </div>

          <button
            id="export43Btn"
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs text-zinc-100 backdrop-blur hover:bg-white/10 hover:border-white/20"
          >
            Export PNG (4:3)
          </button>
        </div>
      </div>

      <!-- poster -->
      <section
        id="poster"
        class="mt-4 rounded-[28px] border border-white/10 bg-white/5 p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.04)] backdrop-blur-xl"
      >
        <div class="flex items-end justify-between gap-4">
          <div>
            <h1 class="text-2xl font-semibold tracking-tight">
              <span class="bg-gradient-to-r from-fuchsia-400 via-violet-300 to-cyan-300 bg-clip-text text-transparent">
                Colorado 14ers
              </span>
            </h1>
            <div class="mt-1 text-sm text-zinc-400">
              Generated on <span id="genDate"></span>
            </div>
          </div>

          <div class="text-right">
            <div
              id="pill"
              class="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-zinc-200"
            >
              — / — climbed
            </div>
          </div>
        </div>

        <!-- Layout: map left, checklist right -->
        <div class="mt-5 grid gap-4 lg:grid-cols-[1fr_560px] items-start">
          <!-- map card -->
          <div class="relative overflow-hidden rounded-2xl ring-1 ring-white/10">
            <div id="snapMapWrap" class="relative w-full" style="aspect-ratio: 1 / 1; min-height: 560px;">
              <div id="snapMap" class="absolute inset-0"></div>

              <!-- subtle vignette -->
              <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(ellipse_at_center,transparent_45%,rgba(0,0,0,0.38)_100%)]"></div>

              <!-- minimal credit (web) -->
              <div
                id="snapCredit"
                class="pointer-events-none absolute bottom-3 left-3 rounded-xl border border-white/10 bg-black/30 px-3 py-1 text-[10px] text-zinc-100/85 backdrop-blur"
              >
                © Mapbox © OpenStreetMap
              </div>

              <!-- status (keep above credit) -->
              <div
                id="snapStatus"
                class="pointer-events-none absolute bottom-12 left-3 rounded-xl border border-white/10 bg-black/35 px-3 py-1 text-xs text-zinc-100 backdrop-blur"
              >
                Loading…
              </div>
            </div>
          </div>

          <!-- checklist panel -->
          <aside id="miniWrap" class="rounded-2xl border border-white/10 bg-black/10 p-4 flex flex-col" style="min-height:560px;">
            <div class="mb-3 flex items-center justify-between">
              <div class="text-sm font-semibold text-zinc-100">Checklist</div>
            </div>

            <!-- 3 columns (scroll if needed on web only) -->
            <div id="miniGrid" class="grid gap-3 grid-cols-3 flex-1 overflow-auto pr-1"></div>

            <div class="mt-3 text-[11px] text-zinc-500">
              Filled = climbed • Outline = not yet
            </div>
          </aside>
        </div>
      </section>

      <style is:global>
        /* ===== numbered marker ===== */
        .num-marker {
          width: 22px;
          height: 22px;
          border-radius: 999px;
          display: grid;
          place-items: center;
          font-size: 10px;
          font-weight: 750;
          letter-spacing: -0.02em;
          user-select: none;
          box-sizing: border-box;
          transform: translate3d(0,0,0);
        }
        .num-marker span { transform: translateY(-0.4px); }
        .num-marker.dark.notyet {
          color: rgba(244,244,245,0.92);
          border: 1.4px solid rgba(226,232,240,0.80);
          background: rgba(0,0,0,0.28);
          opacity: 0.95;
        }
        .num-marker.dark.climbed {
          color: rgba(0,0,0,0.92);
          border: 1.4px solid rgba(255,255,255,0.95);
          background: rgba(0,255,213,0.95);
          box-shadow:
            0 0 8px rgba(0, 255, 213, 0.50),
            0 0 14px rgba(168, 85, 247, 0.16);
        }

        .snap-mode-btn[aria-pressed="true"] {
          background: rgba(255,255,255,0.10);
          border: 1px solid rgba(255,255,255,0.14);
        }

        /* ===== checklist columns + range sections ===== */
        .col-card {
          border: 1px solid rgba(255,255,255,0.10);
          background: rgba(0,0,0,0.16);
          border-radius: 16px;
          padding: 10px;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          gap: 10px;
          min-width: 0;
        }

        .sec {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .sec-title {
          font-size: 12px;
          font-weight: 800;
          color: rgba(244,244,245,0.92);
          letter-spacing: -0.01em;
          padding: 0 2px;
        }

        .mini-row {
          display:flex;
          align-items:center;
          gap:10px;
          border: 1px solid rgba(255,255,255,0.10);
          background: rgba(0,0,0,0.18);
          border-radius: 12px;
          padding: 7px 10px; /* slightly taller */
          overflow:hidden;
        }

        .mini-num {
          width: 22px;
          height: 22px;
          border-radius: 999px;
          display:grid;
          place-items:center;
          font-size: 11px;
          font-weight: 900;
          border: 1px solid rgba(226,232,240,0.70);
          background: rgba(0,0,0,0.28);
          color: rgba(244,244,245,0.92);
          flex: 0 0 auto;
        }
        .mini-num.climbed {
          background: rgba(0,255,213,0.20);
          border-color: rgba(0,255,213,0.40);
          color: rgba(200,255,248,0.96);
          box-shadow: 0 0 10px rgba(0,255,213,0.08);
        }
        .mini-name {
          min-width:0;
          flex:1 1 auto;
          font-size: 11px;
          font-weight: 700;
          color: rgba(244,244,245,0.90);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        .mini-name.climbed { color: rgba(200,255,248,0.96); }
      </style>

      <script is:inline>
        (function () {
          var STORAGE_KEY = "my14ers_state_v1";

          var MAPBOX_TOKEN = "pk.eyJ1Ijoiemhhbmd5dXR5biIsImEiOiJjbWplcjhmMHIwa2psM2tweTFyaTl3aWVmIn0.zCJY08mlW89VE-CNDsUaOg";
          var MAPBOX_STYLE = "zhangyutyn/cmjeroj9p001x01s1g91zapo2";

          function $(id) { return document.getElementById(id); }

          function setStatus(msg) {
            var el = $("snapStatus");
            if (!el) return;
            el.textContent = msg || "";
            el.style.display = msg ? "block" : "none";
          }

          function normalize(s) {
            s = (s || "").toLowerCase();
            s = s.replace(/mount\s+/g, "mt ");
            s = s.replace(/\bmt\.\s*/g, "mt ");
            s = s.replace(/[()]/g, " ");
            s = s.replace(/[^a-z0-9\s]/g, "");
            s = s.replace(/\s+/g, " ").trim();
            return s;
          }

          function loadState() {
            try {
              var raw = localStorage.getItem(STORAGE_KEY);
              if (!raw) return { climbed: {} };
              var obj = JSON.parse(raw);
              if (!obj || typeof obj !== "object") return { climbed: {} };
              if (!obj.climbed || typeof obj.climbed !== "object") obj.climbed = {};
              return obj;
            } catch (e) {
              return { climbed: {} };
            }
          }

          // === grouping into 3 columns ===
          function columnGroupForRange(range) {
            var r = (range || "").toLowerCase();
            if (r.indexOf("front") !== -1) return "col1";
            if (r.indexOf("sangre") !== -1) return "col1";
            if (r.indexOf("mosquito") !== -1) return "col2";
            if (r.indexOf("sawatch") !== -1) return "col2";
            if (r.indexOf("elk") !== -1) return "col3";
            if (r.indexOf("san juan") !== -1) return "col3";
            return "col2";
          }

          function groupRank(range) {
            var g = columnGroupForRange(range);
            if (g === "col1") return 1;
            if (g === "col2") return 2;
            if (g === "col3") return 3;
            return 9;
          }

          // Numbering: left column first, then middle, then right.
          function assignNumbersLeftToRight(listData) {
            var copy = listData.slice();
            copy.sort(function (a, b) {
              var ga = groupRank(a.range), gb = groupRank(b.range);
              if (ga !== gb) return ga - gb;
              if (a.lon !== b.lon) return a.lon - b.lon;      // west->east
              if (a.lat !== b.lat) return b.lat - a.lat;      // north->south
              return (a.name || "").localeCompare(b.name || "");
            });
            for (var i = 0; i < copy.length; i++) copy[i].number = i + 1;
          }

          function markerIcon(number, climbed) {
            var state = climbed ? "climbed" : "notyet";
            var html = '<div class="num-marker dark ' + state + '"><span>' + number + "</span></div>";
            return window.L.divIcon({
              className: "",
              html: html,
              iconSize: [20, 20],
              iconAnchor: [10, 10],
            });
          }

          function shortName(name) {
            var s = String(name || "Unknown");
            s = s.replace(/^Mount\s+/i, "Mt. ");
            s = s.replace(/^Mt\s+/i, "Mt. ");
            s = s.replace(/\s+Mountain$/i, " Mtn.");
            s = s.replace(/\s+Peak$/i, " Peak");
            s = s.replace(/\s+Point$/i, " Pt.");
            return s;
          }

          function setMode(mode) {
            var mini = $("miniWrap");
            var pill = $("pill");

            function press(id, on) {
              var b = $(id);
              if (!b) return;
              b.setAttribute("aria-pressed", on ? "true" : "false");
            }

            if (mode === "count") {
              if (mini) mini.classList.add("hidden");
              if (pill) pill.classList.remove("hidden");
              press("modeCount", true); press("modeMini", false); press("modeHide", false);
            } else if (mode === "mini") {
              if (mini) mini.classList.remove("hidden");
              if (pill) pill.classList.add("hidden");
              press("modeCount", false); press("modeMini", true); press("modeHide", false);
            } else {
              if (mini) mini.classList.add("hidden");
              if (pill) pill.classList.add("hidden");
              press("modeCount", false); press("modeMini", false); press("modeHide", true);
            }
          }

          // --- WebMercator fit helpers (deterministic export framing) ---
          function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }

          function latLngToWorldPx(lat, lon, z) {
            var sin = Math.sin(lat * Math.PI / 180);
            sin = clamp(sin, -0.9999, 0.9999);
            var scale = 256 * Math.pow(2, z);
            var x = (lon + 180) / 360 * scale;
            var y = (0.5 - Math.log((1 + sin) / (1 - sin)) / (4 * Math.PI)) * scale;
            return { x: x, y: y };
          }

          function getFitZoomForBounds(bounds, w, h, padPx) {
            var padding = padPx || 0;
            var W = Math.max(1, w - 2 * padding);
            var H = Math.max(1, h - 2 * padding);

            var sw = bounds.getSouthWest();
            var ne = bounds.getNorthEast();

            for (var z = 14; z >= 4; z--) {
              var a = latLngToWorldPx(sw.lat, sw.lng, z);
              var b = latLngToWorldPx(ne.lat, ne.lng, z);
              var dx = Math.abs(b.x - a.x);
              var dy = Math.abs(b.y - a.y);
              if (dx <= W && dy <= H) return z;
            }
            return 4;
          }

          function getStaticView(bounds, sizePx) {
            var pad = 26;                  // tighter => zooms in
            var z = getFitZoomForBounds(bounds, sizePx, sizePx, pad);
            z = Math.min(z + 1, 12);       // bump in slightly so it’s not too zoomed out
            var c = bounds.getCenter();
            return { center: c, zoom: z };
          }

          function renderChecklist3ColsWithRanges(listData) {
            var grid = $("miniGrid");
            if (!grid) return;

            function rangeKey(r) {
              r = (r || "").toLowerCase();
              if (r.indexOf("front") !== -1) return "Front Range";
              if (r.indexOf("sangre") !== -1) return "Sangre de Cristo Range";
              if (r.indexOf("mosquito") !== -1) return "Mosquito Range";
              if (r.indexOf("sawatch") !== -1) return "Sawatch Range";
              if (r.indexOf("elk") !== -1) return "Elk Mountains";
              if (r.indexOf("san juan") !== -1) return "San Juan Mountains";
              return "Other";
            }

            var colDefs = [
              { key: "col1", sections: ["Front Range", "Sangre de Cristo Range"] },
              { key: "col2", sections: ["Mosquito Range", "Sawatch Range"] },
              { key: "col3", sections: ["Elk Mountains", "San Juan Mountains"] },
            ];

            var cols = {
              col1: { "Front Range": [], "Sangre de Cristo Range": [] },
              col2: { "Mosquito Range": [], "Sawatch Range": [] },
              col3: { "Elk Mountains": [], "San Juan Mountains": [] },
            };

            for (var i = 0; i < listData.length; i++) {
              var it = listData[i];
              var col = columnGroupForRange(it.range);
              var rk = rangeKey(it.range);

              if (col === "col1") {
                if (rk !== "Front Range" && rk !== "Sangre de Cristo Range") rk = "Front Range";
                cols.col1[rk].push(it);
              } else if (col === "col2") {
                if (rk !== "Mosquito Range" && rk !== "Sawatch Range") rk = "Sawatch Range";
                cols.col2[rk].push(it);
              } else {
                if (rk !== "Elk Mountains" && rk !== "San Juan Mountains") rk = "San Juan Mountains";
                cols.col3[rk].push(it);
              }
            }

            Object.keys(cols).forEach(function (ck) {
              Object.keys(cols[ck]).forEach(function (sk) {
                cols[ck][sk].sort(function (a, b) { return a.number - b.number; });
              });
            });

            var html = "";
            for (var c = 0; c < colDefs.length; c++) {
              var def = colDefs[c];
              html += '<div class="col-card">';

              for (var s = 0; s < def.sections.length; s++) {
                var secName = def.sections[s];
                var items = cols[def.key][secName] || [];
                if (!items.length) continue;

                html += '<div class="sec">';
                html += '<div class="sec-title">' + secName + "</div>";

                for (var j = 0; j < items.length; j++) {
                  var it2 = items[j];
                  var nm = shortName(it2.name);
                  html +=
                    '<div class="mini-row" title="' + (it2.name || "") + '">' +
                      '<div class="mini-num ' + (it2.climbed ? "climbed" : "") + '">' + it2.number + "</div>" +
                      '<div class="mini-name ' + (it2.climbed ? "climbed" : "") + '">' + nm + "</div>" +
                    "</div>";
                }

                html += "</div>";
              }

              html += "</div>";
            }

            grid.innerHTML = html;
          }

          // ===== Spider engine (live map) =====
          function makeSpiderEngine(map) {
            var linesLayer = window.L.layerGroup().addTo(map);

            function connectedComponents(nodes, minDist) {
              var n = nodes.length;
              var parent = new Array(n);
              for (var i = 0; i < n; i++) parent[i] = i;

              function find(x) {
                while (parent[x] !== x) {
                  parent[x] = parent[parent[x]];
                  x = parent[x];
                }
                return x;
              }
              function union(a, b) {
                var ra = find(a), rb = find(b);
                if (ra !== rb) parent[rb] = ra;
              }

              var min2 = minDist * minDist;
              for (var a = 0; a < n; a++) {
                for (var b = a + 1; b < n; b++) {
                  var dx = nodes[b].p.x - nodes[a].p.x;
                  var dy = nodes[b].p.y - nodes[a].p.y;
                  if (dx * dx + dy * dy < min2) union(a, b);
                }
              }

              var groups = {};
              for (var k = 0; k < n; k++) {
                var r = find(k);
                if (!groups[r]) groups[r] = [];
                groups[r].push(nodes[k]);
              }
              return Object.values(groups);
            }

            function update(markers) {
              linesLayer.clearLayers();
              if (!markers || !markers.length) return;

              var pts = [];
              for (var i = 0; i < markers.length; i++) {
                var mk = markers[i];
                if (!mk || !mk.__origLatLng) continue;
                var ll = mk.__origLatLng;

                if (!map.getBounds().pad(0.10).contains(ll)) {
                  mk.setLatLng(ll);
                  continue;
                }

                var p = map.latLngToLayerPoint(ll);
                pts.push({ mk: mk, orig: ll, p: p, x: p.x, y: p.y, ox: p.x, oy: p.y });
              }
              if (!pts.length) return;

              var minDist = 20;
              var comps = connectedComponents(pts, minDist);

              for (var c = 0; c < comps.length; c++) {
                var comp = comps[c];
                if (comp.length <= 1) {
                  comp[0].mk.setLatLng(comp[0].orig);
                  continue;
                }

                var ITER = 22;
                var spring = 0.10;
                var repel = 0.60;
                var maxDisp = 34;
                var min2 = minDist * minDist;

                for (var ii = 0; ii < comp.length; ii++) {
                  comp[ii].x = comp[ii].ox;
                  comp[ii].y = comp[ii].oy;
                }

                for (var it = 0; it < ITER; it++) {
                  for (var s = 0; s < comp.length; s++) {
                    comp[s].x += (comp[s].ox - comp[s].x) * spring;
                    comp[s].y += (comp[s].oy - comp[s].y) * spring;
                  }

                  for (var a = 0; a < comp.length; a++) {
                    for (var b = a + 1; b < comp.length; b++) {
                      var dx = comp[b].x - comp[a].x;
                      var dy = comp[b].y - comp[a].y;
                      var d2 = dx * dx + dy * dy;

                      if (d2 < 0.0001) {
                        dx = (Math.random() - 0.5) * 0.2;
                        dy = (Math.random() - 0.5) * 0.2;
                        d2 = dx * dx + dy * dy;
                      }

                      if (d2 < min2) {
                        var d = Math.sqrt(d2);
                        var push = (minDist - d) * repel;
                        var ux = dx / d;
                        var uy = dy / d;

                        comp[a].x -= ux * push * 0.5;
                        comp[a].y -= uy * push * 0.5;
                        comp[b].x += ux * push * 0.5;
                        comp[b].y += uy * push * 0.5;
                      }
                    }
                  }

                  for (var k = 0; k < comp.length; k++) {
                    var ddx = comp[k].x - comp[k].ox;
                    var ddy = comp[k].y - comp[k].oy;
                    var dist = Math.sqrt(ddx * ddx + ddy * ddy);
                    if (dist > maxDisp) {
                      comp[k].x = comp[k].ox + (ddx / dist) * maxDisp;
                      comp[k].y = comp[k].oy + (ddy / dist) * maxDisp;
                    }
                  }
                }

                for (var pIdx = 0; pIdx < comp.length; pIdx++) {
                  var newP = window.L.point(comp[pIdx].x, comp[pIdx].y);
                  var newLL = map.layerPointToLatLng(newP);

                  comp[pIdx].mk.setLatLng(newLL);

                  window.L.polyline([comp[pIdx].orig, newLL], {
                    color: "rgba(255,255,255,0.28)",
                    weight: 1,
                    opacity: 1,
                    interactive: false,
                  }).addTo(linesLayer);
                }
              }
            }

            return { update: update };
          }

          function downloadDataUrl(dataUrl, filename) {
            var a = document.createElement("a");
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
          }

          // ===== Export 4:3 canvas (1600×1200) =====
          async function exportPNG43(map, listData, done, total, exportView) {
            var W = 1600, H = 1200;
            var PAD = 72;
            var GAP = 36;

            var mapSize = 780;

            // UPDATED: smaller header + push everything down a bit (less empty bottom)
            var headerH = 120;
            var mapX = PAD;
            var mapY = headerH + 44;

            var panelX = mapX + mapSize + GAP;
            var panelY = mapY;
            var panelW = W - PAD - panelX;
            var panelH = mapSize;

            var center = exportView.center;
            var zoom = exportView.zoom;

            // Mapbox static (logo/attr flags may be ignored)
            var staticUrl =
              "https://api.mapbox.com/styles/v1/" + MAPBOX_STYLE + "/static/" +
              center.lng + "," + center.lat + "," + zoom + ",0/" +
              mapSize + "x" + mapSize +
              "?access_token=" + MAPBOX_TOKEN +
              "&logo=false&attribution=false";

            var img = new Image();
            img.crossOrigin = "anonymous";
            img.referrerPolicy = "no-referrer";

            await new Promise(function (resolve, reject) {
              img.onload = resolve;
              img.onerror = function () { reject(new Error("Static image failed to load")); };
              img.src = staticUrl;
            });

            var canvas = document.createElement("canvas");
            canvas.width = W;
            canvas.height = H;
            var ctx = canvas.getContext("2d");

            // bg
            ctx.fillStyle = "rgb(9,9,11)";
            ctx.fillRect(0, 0, W, H);

            // subtle glow
            var grd = ctx.createRadialGradient(W*0.25, H*0.15, 10, W*0.25, H*0.15, W*0.9);
            grd.addColorStop(0, "rgba(168,85,247,0.18)");
            grd.addColorStop(0.55, "rgba(34,211,238,0.10)");
            grd.addColorStop(1, "rgba(0,0,0,0)");
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, W, H);

            // title (UPDATED: slightly lower)
            ctx.fillStyle = "rgba(244,244,245,0.96)";
            ctx.font = "800 64px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
            ctx.fillText("Colorado 14ers", PAD, 98);

            // pill
            var pillText = done + " / " + total + " climbed";
            ctx.font = "700 20px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
            var pillW = Math.ceil(ctx.measureText(pillText).width) + 30;
            var pillH = 40;
            var pillX = W - PAD - pillW;
            var pillY = 96; // align with title

            ctx.fillStyle = "rgba(255,255,255,0.06)";
            roundRect(ctx, pillX, pillY, pillW, pillH, 999, true, false);
            ctx.strokeStyle = "rgba(255,255,255,0.12)";
            ctx.lineWidth = 1;
            roundRect(ctx, pillX, pillY, pillW, pillH, 999, false, true);

            ctx.fillStyle = "rgba(244,244,245,0.92)";
            ctx.fillText(pillText, pillX + 15, pillY + 26);

            // map card
            drawCard(ctx, mapX, mapY, mapSize, mapSize, 26);
            ctx.save();
            clipRoundRect(ctx, mapX, mapY, mapSize, mapSize, 26);
            ctx.drawImage(img, mapX, mapY, mapSize, mapSize);
            ctx.restore();

            // spider markers in pixel space
            var crs = map.options.crs;
            var z = zoom;
            var centerPoint = crs.latLngToPoint(center, z);
            var topLeft = window.L.point(centerPoint.x - mapSize / 2, centerPoint.y - mapSize / 2);

            var pts = [];
            for (var i = 0; i < listData.length; i++) {
              var it = listData[i];
              var ll = window.L.latLng(it.lat, it.lon);
              var p = crs.latLngToPoint(ll, z);
              pts.push({
                it: it,
                ox: p.x - topLeft.x,
                oy: p.y - topLeft.y,
                x:  p.x - topLeft.x,
                y:  p.y - topLeft.y
              });
            }
            spiderPixels(pts, 20, 22, 0.10, 0.60, 34);

            // draw lines + markers on map
            ctx.save();
            clipRoundRect(ctx, mapX, mapY, mapSize, mapSize, 26);

            ctx.strokeStyle = "rgba(255,255,255,0.26)";
            ctx.lineWidth = 1;
            for (var li = 0; li < pts.length; li++) {
              var p0x = mapX + pts[li].ox;
              var p0y = mapY + pts[li].oy;
              var p1x = mapX + pts[li].x;
              var p1y = mapY + pts[li].y;
              if (Math.abs(p1x - p0x) < 0.2 && Math.abs(p1y - p0y) < 0.2) continue;
              ctx.beginPath();
              ctx.moveTo(p0x, p0y);
              ctx.lineTo(p1x, p1y);
              ctx.stroke();
            }

            for (var mi = 0; mi < pts.length; mi++) {
              drawMarker(ctx, mapX + pts[mi].x, mapY + pts[mi].y, pts[mi].it.number, pts[mi].it.climbed, 1.0);
            }

            // minimal credit INSIDE the exported map (so it always appears)
            ctx.fillStyle = "rgba(244,244,245,0.70)";
            ctx.font = "600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
            ctx.textAlign = "left";
            ctx.textBaseline = "alphabetic";
            ctx.fillText("© Mapbox © OpenStreetMap", mapX + 18, mapY + mapSize - 16);

            ctx.restore();

            // checklist panel
            drawCard(ctx, panelX, panelY, panelW, panelH, 26);

            ctx.fillStyle = "rgba(244,244,245,0.92)";
            ctx.font = "800 24px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
            ctx.fillText("Checklist", panelX + 18, panelY + 38);

            function rangeKey(r) {
              r = (r || "").toLowerCase();
              if (r.indexOf("front") !== -1) return "Front Range";
              if (r.indexOf("sangre") !== -1) return "Sangre de Cristo Range";
              if (r.indexOf("mosquito") !== -1) return "Mosquito Range";
              if (r.indexOf("sawatch") !== -1) return "Sawatch Range";
              if (r.indexOf("elk") !== -1) return "Elk Mountains";
              if (r.indexOf("san juan") !== -1) return "San Juan Mountains";
              return "Other";
            }

            var colDefs = [
              { sections: ["Front Range", "Sangre de Cristo Range"] },
              { sections: ["Mosquito Range", "Sawatch Range"] },
              { sections: ["Elk Mountains", "San Juan Mountains"] },
            ];

            var cols = [
              { "Front Range": [], "Sangre de Cristo Range": [] },
              { "Mosquito Range": [], "Sawatch Range": [] },
              { "Elk Mountains": [], "San Juan Mountains": [] },
            ];

            for (var bi = 0; bi < listData.length; bi++) {
              var itB = listData[bi];
              var col = columnGroupForRange(itB.range);
              var rk = rangeKey(itB.range);

              if (col === "col1") {
                if (rk !== "Front Range" && rk !== "Sangre de Cristo Range") rk = "Front Range";
                cols[0][rk].push(itB);
              } else if (col === "col2") {
                if (rk !== "Mosquito Range" && rk !== "Sawatch Range") rk = "Sawatch Range";
                cols[1][rk].push(itB);
              } else {
                if (rk !== "Elk Mountains" && rk !== "San Juan Mountains") rk = "San Juan Mountains";
                cols[2][rk].push(itB);
              }
            }

            for (var ci = 0; ci < 3; ci++) {
              Object.keys(cols[ci]).forEach(function (k) {
                cols[ci][k].sort(function(a,b){ return a.number - b.number; });
              });
            }

            var innerPad = 18;
            var colGap = 12;
            var colW = Math.floor((panelW - innerPad*2 - colGap*2) / 3);

            var startX = panelX + innerPad;
            var startY = panelY + 56;

            for (var c = 0; c < 3; c++) {
              var cx = startX + c*(colW + colGap);
              var cy = startY;

              for (var si = 0; si < colDefs[c].sections.length; si++) {
                var sec = colDefs[c].sections[si];
                var items = cols[c][sec] || [];
                if (!items.length) continue;

                ctx.fillStyle = "rgba(244,244,245,0.90)";
                ctx.font = "800 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
                ctx.fillText(sec, cx, cy + 14);
                cy += 22;

                var rowH = 26;

                for (var ri = 0; ri < items.length; ri++) {
                  var itR = items[ri];

                  ctx.fillStyle = "rgba(0,0,0,0.18)";
                  roundRect(ctx, cx, cy, colW, 22, 11, true, false);
                  ctx.strokeStyle = "rgba(255,255,255,0.10)";
                  ctx.lineWidth = 1;
                  roundRect(ctx, cx, cy, colW, 22, 11, false, true);

                  drawMiniNum(ctx, cx + 12, cy + 11, itR.number, itR.climbed, 9);

                  var nm = shortName(itR.name);
                  ctx.fillStyle = itR.climbed ? "rgba(200,255,248,0.96)" : "rgba(244,244,245,0.90)";
                  ctx.font = "700 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
                  ctx.fillText(ellipsis(ctx, nm, colW - 44), cx + 30, cy + 15);

                  cy += rowH;
                  if (cy > panelY + panelH - 24) break;
                }

                cy += 6;
                if (cy > panelY + panelH - 24) break;
              }
            }

            // UPDATED: removed the "Filled = climbed ..." legend on export

            downloadDataUrl(canvas.toDataURL("image/png"), "my14ers-snapshot-4x3.png");
          }

          function ellipsis(ctx, text, maxW) {
            if (ctx.measureText(text).width <= maxW) return text;
            var t = text;
            while (t.length > 3 && ctx.measureText(t + "…").width > maxW) t = t.slice(0, -1);
            return t + "…";
          }

          function drawCard(ctx, x, y, w, h, r) {
            ctx.fillStyle = "rgba(255,255,255,0.05)";
            roundRect(ctx, x, y, w, h, r, true, false);
            ctx.strokeStyle = "rgba(255,255,255,0.10)";
            ctx.lineWidth = 1;
            roundRect(ctx, x, y, w, h, r, false, true);
          }

          function drawMiniNum(ctx, cx, cy, number, climbed, r) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI*2);
            if (climbed) {
              ctx.fillStyle = "rgba(0,255,213,0.20)";
              ctx.fill();
              ctx.strokeStyle = "rgba(0,255,213,0.40)";
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.fillStyle = "rgba(200,255,248,0.96)";
            } else {
              ctx.fillStyle = "rgba(0,0,0,0.28)";
              ctx.fill();
              ctx.strokeStyle = "rgba(226,232,240,0.70)";
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.fillStyle = "rgba(244,244,245,0.92)";
            }
            ctx.font = "900 11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(String(number), cx, cy + 0.5);
            ctx.restore();
          }

          function drawMarker(ctx, x, y, number, climbed, scale) {
            var r = 11 * scale;
            var strokeW = 1.4 * scale;

            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI*2);

            if (climbed) {
              ctx.fillStyle = "rgba(0,255,213,0.95)";
              ctx.fill();
              ctx.lineWidth = strokeW;
              ctx.strokeStyle = "rgba(255,255,255,0.95)";
              ctx.stroke();

              ctx.shadowColor = "rgba(0,255,213,0.30)";
              ctx.shadowBlur = 10 * scale;
              ctx.beginPath();
              ctx.arc(x, y, r, 0, Math.PI*2);
              ctx.stroke();
              ctx.shadowBlur = 0;

              ctx.fillStyle = "rgba(0,0,0,0.92)";
            } else {
              ctx.fillStyle = "rgba(0,0,0,0.28)";
              ctx.fill();
              ctx.lineWidth = strokeW;
              ctx.strokeStyle = "rgba(226,232,240,0.80)";
              ctx.stroke();
              ctx.fillStyle = "rgba(244,244,245,0.92)";
            }

            ctx.font = (10 * scale) + "px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(String(number), x, y + (0.2 * scale));
            ctx.restore();
          }

          function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (r > h/2) r = h/2;
            if (r > w/2) r = w/2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
          }

          function clipRoundRect(ctx, x, y, w, h, r) {
            if (r > h/2) r = h/2;
            if (r > w/2) r = w/2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
            ctx.clip();
          }

          // Spider in pixel space (for export)
          function spiderPixels(points, minDist, ITER, spring, repel, maxDisp) {
            function connectedComponents(nodes, minDist) {
              var n = nodes.length;
              var parent = new Array(n);
              for (var i = 0; i < n; i++) parent[i] = i;

              function find(x) {
                while (parent[x] !== x) {
                  parent[x] = parent[parent[x]];
                  x = parent[x];
                }
                return x;
              }
              function union(a, b) {
                var ra = find(a), rb = find(b);
                if (ra !== rb) parent[rb] = ra;
              }

              var min2 = minDist * minDist;
              for (var a = 0; a < n; a++) {
                for (var b = a + 1; b < n; b++) {
                  var dx = nodes[b].ox - nodes[a].ox;
                  var dy = nodes[b].oy - nodes[a].oy;
                  if (dx*dx + dy*dy < min2) union(a, b);
                }
              }

              var groups = {};
              for (var k = 0; k < n; k++) {
                var r = find(k);
                if (!groups[r]) groups[r] = [];
                groups[r].push(nodes[k]);
              }
              return Object.values(groups);
            }

            var comps = connectedComponents(points, minDist);
            var min2 = minDist * minDist;

            for (var c = 0; c < comps.length; c++) {
              var comp = comps[c];
              if (comp.length <= 1) {
                comp[0].x = comp[0].ox;
                comp[0].y = comp[0].oy;
                continue;
              }

              for (var ii = 0; ii < comp.length; ii++) {
                comp[ii].x = comp[ii].ox;
                comp[ii].y = comp[ii].oy;
              }

              for (var it = 0; it < ITER; it++) {
                for (var s = 0; s < comp.length; s++) {
                  comp[s].x += (comp[s].ox - comp[s].x) * spring;
                  comp[s].y += (comp[s].oy - comp[s].y) * spring;
                }

                for (var a = 0; a < comp.length; a++) {
                  for (var b = a + 1; b < comp.length; b++) {
                    var dx = comp[b].x - comp[a].x;
                    var dy = comp[b].y - comp[a].y;
                    var d2 = dx*dx + dy*dy;

                    if (d2 < 0.0001) {
                      dx = (Math.random() - 0.5) * 0.2;
                      dy = (Math.random() - 0.5) * 0.2;
                      d2 = dx*dx + dy*dy;
                    }

                    if (d2 < min2) {
                      var d = Math.sqrt(d2);
                      var push = (minDist - d) * repel;
                      var ux = dx / d;
                      var uy = dy / d;

                      comp[a].x -= ux * push * 0.5;
                      comp[a].y -= uy * push * 0.5;
                      comp[b].x += ux * push * 0.5;
                      comp[b].y += uy * push * 0.5;
                    }
                  }
                }

                for (var k = 0; k < comp.length; k++) {
                  var ddx = comp[k].x - comp[k].ox;
                  var ddy = comp[k].y - comp[k].oy;
                  var dist = Math.sqrt(ddx*ddx + ddy*ddy);
                  if (dist > maxDisp) {
                    comp[k].x = comp[k].ox + (ddx/dist) * maxDisp;
                    comp[k].y = comp[k].oy + (ddy/dist) * maxDisp;
                  }
                }
              }
            }
          }

          // ===== main =====
          window.addEventListener("load", function () {
            var genDate = $("genDate");
            if (genDate) genDate.textContent = new Date().toLocaleDateString();

            var bCount = $("modeCount");
            var bMini = $("modeMini");
            var bHide = $("modeHide");
            if (bCount) bCount.addEventListener("click", function(){ setMode("count"); });
            if (bMini) bMini.addEventListener("click", function(){ setMode("mini"); });
            if (bHide) bHide.addEventListener("click", function(){ setMode("hide"); });

            setMode("mini");

            if (!window.L) {
              setStatus("Leaflet failed to load.");
              return;
            }

            setStatus("Loading peaks…");

            fetch("/data/co-14ers.json", { cache: "no-store" })
              .then(function(r){ return r.json(); })
              .then(function(coJson){
                var coPeaks = (coJson && Array.isArray(coJson.peaks)) ? coJson.peaks : [];
                var state = loadState();

                var listData = [];
                var boundsArr = [];

                function keyFor(pk) { return pk && (pk.id ? String(pk.id) : normalize(pk.name)); }

                for (var i = 0; i < coPeaks.length; i++) {
                  var pk = coPeaks[i];
                  if (!pk || typeof pk.lat !== "number" || typeof pk.lon !== "number") continue;

                  var k = keyFor(pk);
                  var climbed = !!(k && state.climbed[k]);

                  listData.push({
                    idKey: k,
                    pk: pk,
                    name: pk.name || "Unknown",
                    range: pk.range || "Unknown Range",
                    climbed: climbed,
                    lat: pk.lat,
                    lon: pk.lon,
                    number: 0,
                  });

                  boundsArr.push([pk.lat, pk.lon]);
                }

                assignNumbersLeftToRight(listData);

                var done = 0;
                for (var j = 0; j < listData.length; j++) if (listData[j].climbed) done++;
                var pill = $("pill");
                if (pill) pill.textContent = done + " / " + listData.length + " climbed";

                renderChecklist3ColsWithRanges(listData);

                setStatus("Rendering map…");

                var map = window.L.map("snapMap", {
                  scrollWheelZoom: false,
                  zoomControl: false,
                  attributionControl: false,
                  renderer: window.L.svg(),
                  zoomSnap: 0.1,
                  zoomDelta: 0.2,
                  dragging: false,
                  doubleClickZoom: false,
                  boxZoom: false,
                  keyboard: false,
                  tap: false,
                  touchZoom: false,
                });

                var tiles =
                  "https://api.mapbox.com/styles/v1/" + MAPBOX_STYLE +
                  "/tiles/256/{z}/{x}/{y}@2x?access_token=" + MAPBOX_TOKEN;

                window.L.tileLayer(tiles, {
                  maxZoom: 20,
                  tileSize: 256,
                  zoomOffset: 0,
                }).addTo(map);

                var markerById = {};
                var allMarkers = [];

                function buildMarker(it) {
                  var mk = markerById[it.idKey];
                  var icon = markerIcon(it.number, it.climbed);
                  if (!mk) {
                    mk = window.L.marker([it.lat, it.lon], { icon: icon, interactive: false }).addTo(map);
                    mk.__origLatLng = window.L.latLng([it.lat, it.lon]);
                    markerById[it.idKey] = mk;
                    allMarkers.push(mk);
                  } else {
                    mk.setIcon(icon);
                  }
                }
                for (var m = 0; m < listData.length; m++) buildMarker(listData[m]);

                var exportView = null;
                if (boundsArr.length) {
                  var b = window.L.latLngBounds(boundsArr);
                  exportView = getStaticView(b, 780);
                  map.setView(exportView.center, exportView.zoom, { animate: false });
                } else {
                  exportView = { center: window.L.latLng(39.0, -105.7), zoom: 8 };
                  map.setView(exportView.center, exportView.zoom, { animate: false });
                }

                setTimeout(function () { map.invalidateSize(true); }, 50);

                var spider = makeSpiderEngine(map);
                function refreshSpider(){ spider.update(allMarkers); }

                requestAnimationFrame(function(){
                  map.invalidateSize(true);
                  refreshSpider();
                  setStatus("");
                });

                var exportBtn = $("export43Btn");
                if (exportBtn) {
                  exportBtn.addEventListener("click", async function(){
                    try {
                      exportBtn.disabled = true;
                      exportBtn.textContent = "Exporting…";
                      await exportPNG43(map, listData, done, listData.length, exportView);
                    } catch (e) {
                      console.error(e);
                      alert(
                        "Export failed.\n" +
                        "If Mapbox static is blocked on localhost, deploy to https or use a local tile server."
                      );
                    } finally {
                      exportBtn.disabled = false;
                      exportBtn.textContent = "Export PNG (4:3)";
                    }
                  });
                }
              })
              .catch(function(err){
                console.error("[snapshot] failed:", err);
                setStatus("Failed to load data.");
              });
          });
        })();
      </script>
    </main>
  </body>
</html>