---
const rawBase = import.meta.env.BASE_URL || "/";
const basePath = rawBase === "/" ? "" : rawBase.replace(/\/$/, "");
const defaultCoDataUrl = `${basePath}/data/co-14ers.json`;

const {
  coDataUrl = defaultCoDataUrl,
  mapId = "co14ersMap",
} = Astro.props as {
  coDataUrl?: string;
  mapId?: string;
};
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

<style>
  .leaflet-container {
    background: transparent;
    border-radius: 1rem;
  }
  .leaflet-tile.hillshade-tile {
    mix-blend-mode: multiply;
  }
</style>

<style is:global>
  /* ===== Leaflet dark UI ===== */
  .leaflet-container .leaflet-control {
    background: transparent !important;
    box-shadow: none !important;
  }

  .leaflet-control-zoom {
    border: 1px solid rgba(255, 255, 255, 0.10) !important;
    border-radius: 14px !important;
    overflow: hidden;
    backdrop-filter: blur(10px);
    background: rgba(0, 0, 0, 0.30) !important;
  }

  .leaflet-control-zoom a.leaflet-control-zoom-in,
  .leaflet-control-zoom a.leaflet-control-zoom-out {
    background: rgba(0, 0, 0, 0.35) !important;
    color: rgba(244, 244, 245, 0.95) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.10) !important;
  }
  .leaflet-control-zoom a.leaflet-control-zoom-out { border-bottom: none !important; }
  .leaflet-control-zoom a:hover { background: rgba(255, 255, 255, 0.08) !important; }

  .leaflet-control-attribution {
    background: rgba(0, 0, 0, 0.28) !important;
    color: rgba(244, 244, 245, 0.72) !important;
    border: 1px solid rgba(255, 255, 255, 0.10);
    border-radius: 12px;
    padding: 3px 8px;
    backdrop-filter: blur(10px);
  }
  .leaflet-control-attribution a { color: rgba(244, 244, 245, 0.85) !important; }

  /* Reset control (dark) */
  .leaflet-container .leaflet-control-reset a {
    background: rgba(0, 0, 0, 0.35) !important;
    color: rgba(244, 244, 245, 0.95) !important;
    text-decoration: none !important;
    font-size: 16px;
    line-height: 26px;
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 14px;
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
    backdrop-filter: blur(10px);
  }
  .leaflet-container .leaflet-control-reset a:hover { background: rgba(255,255,255,0.08) !important; }

  /* ===== Numbered marker (DivIcon) ===== */
  .num-marker {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    display: grid;
    place-items: center;
    font-size: 10px;
    font-weight: 750;
    letter-spacing: -0.02em;
    user-select: none;
    box-sizing: border-box;
    transform: translate3d(0,0,0);
  }
  .num-marker span { transform: translateY(-0.4px); }

  /* Dark base */
  .num-marker.dark.notyet {
    color: rgba(244,244,245,0.92);
    border: 1.4px solid rgba(226,232,240,0.80);
    background: rgba(0,0,0,0.28);
    opacity: 0.95;
  }
  .num-marker.dark.climbed {
    color: rgba(0,0,0,0.92);
    border: 1.4px solid rgba(255,255,255,0.95);
    background: rgba(0,255,213,0.95);
    box-shadow:
      0 0 8px rgba(0, 255, 213, 0.50),
      0 0 14px rgba(168, 85, 247, 0.16);
  }

  /* Light base */
  .num-marker.light.notyet {
    color: rgba(244,244,245,0.92);
    border: 1.4px solid rgba(12,12,12,0.95);
    background: rgba(5,5,5,0.70);
    opacity: 0.95;
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.05),
      0 0 4px rgba(0,0,0,0.35);
  }
  .num-marker.light.climbed {
    color: rgba(245,255,248,0.92);
    border: 1.4px solid rgba(0,0,0,0.95);
    background: rgba(0,163,105,0.95);
    box-shadow:
      0 0 12px rgba(0,163,105,0.45),
      0 0 18px rgba(0,0,0,0.33);
  }

  .num-marker:hover {
    cursor: pointer;
    filter: drop-shadow(0 0 8px rgba(226,232,240,0.25));
  }

  /* Pin button icon */
  .pin-btn svg {
    width: 16px;
    height: 16px;
    opacity: 0.95;
  }

  /* ===== Two-line clamp for checklist peak names ===== */
  .peak-name-2line {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.15;
  }
</style>

<section class="w-full overflow-x-hidden rounded-3xl border border-white/10 bg-black/15 p-5 shadow-sm backdrop-blur">
  <div class="mb-4 grid gap-3 rounded-2xl border border-white/10 bg-black/20 p-3 md:grid-cols-12 md:items-center">
    <div class="md:col-span-4">
      <div class="text-sm text-zinc-300">Check peaks in the checklist. Data stays in your browser.</div>
      <span
        id="coCountPill"
        class="mt-2 inline-flex items-center gap-2 rounded-full border border-white/10 bg-black/20 px-3 py-1 text-xs text-zinc-200"
      >
        — / — climbed
      </span>
    </div>

    <div class="md:col-span-8 flex flex-wrap items-center justify-start gap-2 md:justify-end">
      <label class="text-xs text-zinc-300">Base</label>
      <select
        id="baseStyle"
        class="rounded-2xl border border-white/10 bg-black/20 px-3 py-2 text-sm text-zinc-100 outline-none backdrop-blur hover:bg-black/30"
      >
        <option value="dark" selected>Dark (Neon Purple)</option>
        <option value="light">Light (Relief)</option>
      </select>

      <input
        id="peakSearch"
        type="search"
        placeholder="Search peaks…"
        class="w-64 max-w-full rounded-2xl border border-white/10 bg-black/20 px-3 py-2 text-sm text-zinc-100 outline-none placeholder:text-zinc-500 backdrop-blur focus:border-white/20"
      />

      <button
        id="exportBtn"
        class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm text-zinc-100 backdrop-blur hover:bg-white/10 hover:border-white/20"
      >
        Export JSON
      </button>

      <label
        class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm text-zinc-100 backdrop-blur hover:bg-white/10 hover:border-white/20"
      >
        Import JSON
        <input id="importFile" type="file" accept="application/json" class="hidden" />
      </label>

      <button
        id="clearBtn"
        class="rounded-2xl border border-white/10 bg-black/20 px-4 py-2 text-sm text-zinc-100 backdrop-blur hover:bg-black/30 hover:border-white/20"
      >
        Clear all
      </button>

      <button
        id="exportSnapshotBtn"
        class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-zinc-100 backdrop-blur hover:bg-white/10 hover:border-white/20"
        aria-label="Export PNG"
        title="Export PNG"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
          <rect x="3" y="7" width="18" height="14" rx="2" ry="2"></rect>
          <path d="M8 7V5h8v2"></path>
          <circle cx="12" cy="13" r="3"></circle>
        </svg>
      </button>
    </div>
  </div>

  <div class="w-full min-w-0 rounded-2xl border border-white/10 bg-black/20 p-3">
    <div class="flex items-center justify-between">
      <h2 class="text-sm font-semibold text-zinc-100">Colorado 14ers</h2>
      <div id="statusText" class="text-xs text-zinc-400">Loading…</div>
    </div>

    <div class="mt-3 overflow-hidden rounded-2xl ring-1 ring-white/10">
      <div class="mx-auto w-full max-w-[680px]">
        <div id={mapId} class="relative w-full" style="aspect-ratio: 1 / 1; min-height: 320px;"></div>
      </div>
    </div>

    <div class="mt-4 w-full min-w-0 rounded-2xl border border-white/10 bg-black/10 p-4 overflow-x-hidden">
      <div class="mb-3 flex items-center justify-between">
        <div class="text-sm font-semibold text-zinc-100">Checklist</div>
        <div class="text-xs text-zinc-500">Front+Sangre · Mosquito+Sawatch · Elk+San Juan</div>
      </div>

      <div class="grid w-full min-w-0 gap-4 grid-cols-1 md:grid-cols-2 xl:grid-cols-3 items-start">
        <div id="range_frontsangre" class="min-w-0 w-full rounded-2xl border border-white/10 bg-black/15 p-3"></div>
        <div id="range_mosquitosawatch" class="min-w-0 w-full rounded-2xl border border-white/10 bg-black/15 p-3"></div>
        <div id="range_elksanjuan" class="min-w-0 w-full rounded-2xl border border-white/10 bg-black/15 p-3"></div>
      </div>

      <div class="mt-3 text-xs text-zinc-500">
        Click a row to toggle climbed. Use the pin button to jump to a peak.
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ coDataUrl, mapId }}>
    (function () {
      var CO_URL = coDataUrl;
      var MAP_ID = mapId;

      var MAPBOX_TOKEN = "pk.eyJ1Ijoiemhhbmd5dXR5biIsImEiOiJjbWplcjhmMHIwa2psM2tweTFyaTl3aWVmIn0.zCJY08mlW89VE-CNDsUaOg";
      var STORAGE_KEY = "my14ers_state_v1";
      var currentBase = "dark";
      var isExportingSnapshot = false;

      var MAPBOX_STYLE_DARK = "zhangyutyn/cmjeroj9p001x01s1g91zapo2";
      var MAPBOX_STYLE_LIGHT = "zhangyutyn/cmjito95u000c01qq9iqxcv9y";

      function $(id) { return document.getElementById(id); }

      function mapboxStyleForBase(base) {
        return (base === "light") ? MAPBOX_STYLE_LIGHT : MAPBOX_STYLE_DARK;
      }

      function normalize(s) {
        s = (s || "").toLowerCase();
        s = s.replace(/mount\\s+/g, "mt ");
        s = s.replace(/\\bmt\\.\\s*/g, "mt ");
        s = s.replace(/[()]/g, " ");
        s = s.replace(/[^a-z0-9\\s]/g, "");
        s = s.replace(/\\s+/g, " ").trim();
        return s;
      }

      function loadState() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return { climbed: {} };
          var obj = JSON.parse(raw);
          if (!obj || typeof obj !== "object") return { climbed: {} };
          if (!obj.climbed || typeof obj.climbed !== "object") obj.climbed = {};
          return obj;
        } catch (e) {
          return { climbed: {} };
        }
      }

      function saveState(state) { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

      function setStatus(msg) {
        var el = $("statusText");
        if (el) el.textContent = msg || "";
      }

      function setCount(done, total) {
        var pill = $("coCountPill");
        if (pill) pill.textContent = done + " / " + total + " climbed";
      }

      function columnGroupForRange(range) {
        var r = (range || "").toLowerCase();

        if (r.indexOf("front") !== -1) return "frontsangre";
        if (r.indexOf("sangre") !== -1) return "frontsangre";

        if (r.indexOf("mosquito") !== -1) return "mosquitosawatch";
        if (r.indexOf("sawatch") !== -1) return "mosquitosawatch";

        if (r.indexOf("elk") !== -1) return "elksanjuan";
        if (r.indexOf("san juan") !== -1) return "elksanjuan";

        return "mosquitosawatch";
      }

      function rangePriority(range) {
        var r = (range || "").toLowerCase();
        if (r.indexOf("front") !== -1) return 1;
        if (r.indexOf("sangre") !== -1) return 2;
        if (r.indexOf("mosquito") !== -1) return 3;
        if (r.indexOf("sawatch") !== -1) return 4;
        if (r.indexOf("elk") !== -1) return 5;
        if (r.indexOf("san juan") !== -1) return 6;
        return 99;
      }

      function rangeTitle(range) { return range || "Unknown Range"; }

      function rangeSortKey(range) {
        var r = (range || "").toLowerCase();

        if (r.indexOf("front") !== -1) return 1;
        if (r.indexOf("sangre") !== -1) return 2;

        if (r.indexOf("mosquito") !== -1) return 1;
        if (r.indexOf("sawatch") !== -1) return 2;

        if (r.indexOf("elk") !== -1) return 1;
        if (r.indexOf("san juan") !== -1) return 2;

        return 99;
      }

      function markerIcon(number, climbed) {
        var base = (currentBase === "light") ? "light" : "dark";
        var state = climbed ? "climbed" : "notyet";
        var html = '<div class="num-marker ' + base + " " + state + '"><span>' + number + "</span></div>";
        return window.L.divIcon({
          className: "",
          html: html,
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        });
      }

      function makeSpiderEngine(map) {
        var linesLayer = window.L.layerGroup().addTo(map);

        function lineColor() {
          return (currentBase === "light") ? "rgba(0,0,0,0.55)" : "rgba(255,255,255,0.35)";
        }

        function connectedComponents(nodes, minDist) {
          var n = nodes.length;
          var parent = new Array(n);
          for (var i = 0; i < n; i++) parent[i] = i;

          function find(x) {
            while (parent[x] !== x) {
              parent[x] = parent[parent[x]];
              x = parent[x];
            }
            return x;
          }
          function union(a, b) {
            var ra = find(a), rb = find(b);
            if (ra !== rb) parent[rb] = ra;
          }

          var min2 = minDist * minDist;
          for (var a = 0; a < n; a++) {
            for (var b = a + 1; b < n; b++) {
              var dx = nodes[b].p.x - nodes[a].p.x;
              var dy = nodes[b].p.y - nodes[a].p.y;
              if (dx * dx + dy * dy < min2) union(a, b);
            }
          }

          var groups = {};
          for (var k = 0; k < n; k++) {
            var r = find(k);
            if (!groups[r]) groups[r] = [];
            groups[r].push(nodes[k]);
          }
          return Object.values(groups);
        }

        function update(markers) {
          if (!markers || !markers.length) return;
          linesLayer.clearLayers();

          var pts = [];
          for (var i = 0; i < markers.length; i++) {
            var mk = markers[i];
            if (!mk || !mk.__origLatLng) continue;

            var ll = mk.__origLatLng;
            if (!map.getBounds().pad(0.10).contains(ll)) {
              mk.setLatLng(ll);
              continue;
            }

            var p = map.latLngToLayerPoint(ll);
            pts.push({
              mk: mk,
              orig: ll,
              p: p,
              x: p.x, y: p.y,
              ox: p.x, oy: p.y,
            });
          }

          if (!pts.length) return;

          var minDist = 20;
          var comps = connectedComponents(pts, minDist);

          for (var c = 0; c < comps.length; c++) {
            var comp = comps[c];
            if (comp.length <= 1) {
              comp[0].mk.setLatLng(comp[0].orig);
              continue;
            }

            var ITER = 22;
            var spring = 0.10;
            var repel = 0.60;
            var maxDisp = 34;
            var min2 = minDist * minDist;

            for (var ii = 0; ii < comp.length; ii++) {
              comp[ii].x = comp[ii].ox;
              comp[ii].y = comp[ii].oy;
            }

            for (var it = 0; it < ITER; it++) {
              for (var s = 0; s < comp.length; s++) {
                comp[s].x += (comp[s].ox - comp[s].x) * spring;
                comp[s].y += (comp[s].oy - comp[s].y) * spring;
              }

              for (var a = 0; a < comp.length; a++) {
                for (var b = a + 1; b < comp.length; b++) {
                  var dx = comp[b].x - comp[a].x;
                  var dy = comp[b].y - comp[a].y;
                  var d2 = dx * dx + dy * dy;

                  if (d2 < 0.0001) {
                    dx = (Math.random() - 0.5) * 0.2;
                    dy = (Math.random() - 0.5) * 0.2;
                    d2 = dx * dx + dy * dy;
                  }

                  if (d2 < min2) {
                    var d = Math.sqrt(d2);
                    var push = (minDist - d) * repel;
                    var ux = dx / d;
                    var uy = dy / d;

                    comp[a].x -= ux * push * 0.5;
                    comp[a].y -= uy * push * 0.5;
                    comp[b].x += ux * push * 0.5;
                    comp[b].y += uy * push * 0.5;
                  }
                }
              }

              for (var k = 0; k < comp.length; k++) {
                var ddx = comp[k].x - comp[k].ox;
                var ddy = comp[k].y - comp[k].oy;
                var dist = Math.sqrt(ddx * ddx + ddy * ddy);
                if (dist > maxDisp) {
                  comp[k].x = comp[k].ox + (ddx / dist) * maxDisp;
                  comp[k].y = comp[k].oy + (ddy / dist) * maxDisp;
                }
              }
            }

            for (var pIdx = 0; pIdx < comp.length; pIdx++) {
              var newP = window.L.point(comp[pIdx].x, comp[pIdx].y);
              var newLL = map.layerPointToLatLng(newP);

              comp[pIdx].mk.setLatLng(newLL);

              window.L.polyline([comp[pIdx].orig, newLL], {
                color: lineColor(),
                weight: 1,
                opacity: 1,
                interactive: false,
              }).addTo(linesLayer);
            }
          }
        }

        return { update: update };
      }

      window.addEventListener("load", function () {
        if (!window.L) return setStatus("Leaflet failed to load.");
        setStatus("Loading peaks…");

        fetch(CO_URL, { cache: "no-store" })
          .then(function (r) { return r.json(); })
          .then(function (coJson) {
            var coPeaks = (coJson && Array.isArray(coJson.peaks)) ? coJson.peaks : [];
            var state = loadState();

            // ✅ fractional zoom enabled here
            var map = window.L.map(MAP_ID, {
              scrollWheelZoom: true,
              renderer: window.L.svg(),
              zoomSnap: 0.1,
              zoomDelta: 0.2,
            });

            var darkTiles =
              "https://api.mapbox.com/styles/v1/" + mapboxStyleForBase("dark") + "/tiles/256/{z}/{x}/{y}@2x?access_token=" +
              MAPBOX_TOKEN;

            var dark = window.L.tileLayer(darkTiles, {
              maxZoom: 20,
              tileSize: 256,
              zoomOffset: 0,
              attribution: "&copy; Mapbox",
            });

            var lightTiles =
              "https://api.mapbox.com/styles/v1/" + mapboxStyleForBase("light") + "/tiles/256/{z}/{x}/{y}@2x?access_token=" +
              MAPBOX_TOKEN;

            var light = window.L.tileLayer(lightTiles, {
              maxZoom: 20,
              tileSize: 256,
              zoomOffset: 0,
              attribution: "&copy; Mapbox",
            });

            dark.addTo(map);

            var home = { center: null, zoom: null, ready: false };
            function captureHomeFinal() {
              if (home.ready) return;
              requestAnimationFrame(function () {
                home.center = map.getCenter();
                home.zoom = map.getZoom();
                home.ready = true;
              });
            }

            var ResetControl = window.L.Control.extend({
              options: { position: "topleft" },
              onAdd: function () {
                var container = window.L.DomUtil.create("div", "leaflet-control leaflet-control-reset");
                var a = window.L.DomUtil.create("a", "", container);
                a.href = "#";
                a.title = "Reset view";
                a.setAttribute("role", "button");
                a.setAttribute("aria-label", "Reset view");
                a.innerHTML = "⟳";

                window.L.DomEvent.disableClickPropagation(container);
                window.L.DomEvent.on(a, "click", function (e) {
                  window.L.DomEvent.preventDefault(e);
                  if (!home.ready) captureHomeFinal();
                  if (home.center && typeof home.zoom === "number") {
                    map.setView(home.center, home.zoom, { animate: true });
                  }
                });
                return container;
              }
            });
            map.addControl(new ResetControl());

            var markerById = {};
            var allMarkers = [];
            var listData = [];
            var bounds = [];

            function keyFor(pk) { return pk && (pk.id ? String(pk.id) : normalize(pk.name)); }
            function isClimbed(pk) { var k = keyFor(pk); return !!(k && state.climbed[k]); }
            function setClimbed(pk, climbed) {
              var k = keyFor(pk);
              if (!k) return;
              if (climbed) state.climbed[k] = true;
              else delete state.climbed[k];
              saveState(state);
            }

            for (var i = 0; i < coPeaks.length; i++) {
              var pk = coPeaks[i];
              if (!pk || typeof pk.lat !== "number" || typeof pk.lon !== "number") continue;

              var idKey = keyFor(pk);
              var climbed = isClimbed(pk);

              listData.push({
                idKey: idKey,
                pk: pk,
                name: pk.name || "Unknown",
                range: pk.range || "Unknown Range",
                elevation_ft: (typeof pk.elevation_ft === "number" ? pk.elevation_ft : 0),
                climbed: climbed,
                lat: pk.lat,
                lon: pk.lon,
                number: 0,
              });

              bounds.push([pk.lat, pk.lon]);
            }

            function assignNumbersLeftToRight() {
              var copy = listData.slice();
              copy.sort(function (a, b) {
                var pa = rangePriority(a.range), pb = rangePriority(b.range);
                if (pa !== pb) return pa - pb;
                var ra = (a.pk && typeof a.pk.rank === "number") ? a.pk.rank : Number.MAX_SAFE_INTEGER;
                var rb = (b.pk && typeof b.pk.rank === "number") ? b.pk.rank : Number.MAX_SAFE_INTEGER;
                if (ra !== rb) return ra - rb;
                return (a.name || "").localeCompare(b.name || "");
              });

              for (var i = 0; i < copy.length; i++) copy[i].number = i + 1;
            }

            assignNumbersLeftToRight();

            function buildOrUpdateMarker(it) {
              var mk = markerById[it.idKey];
              var icon = markerIcon(it.number, it.climbed);

              if (!mk) {
                mk = window.L.marker([it.lat, it.lon], { icon: icon }).addTo(map);
                mk.__origLatLng = window.L.latLng([it.lat, it.lon]);
                markerById[it.idKey] = mk;
                allMarkers.push(mk);

                var elev = it.pk.elevation_ft ? ("<br/>" + it.pk.elevation_ft + " ft") : "";
                var rng = it.pk.range ? ("<br/>" + it.pk.range) : "";
                mk.bindPopup("<b>" + it.number + ". " + it.name + "</b>" + elev + rng);
              } else {
                mk.setIcon(icon);
              }
            }

            for (var m = 0; m < listData.length; m++) buildOrUpdateMarker(listData[m]);

            if (bounds.length) {
              var b = window.L.latLngBounds(bounds);
              map.fitBounds(b, { padding: [18, 18], maxZoom: 8 });

              // ✅ "in-between" zoom
              var z = map.getZoom();
              map.setZoom(Math.min(z , 10));

              map.once("moveend", captureHomeFinal);
              dark.once("load", captureHomeFinal);
            } else {
              map.setView([39.0, -105.7], 8);
              map.once("moveend", captureHomeFinal);
              dark.once("load", captureHomeFinal);
            }

            var spider = makeSpiderEngine(map);
            function refreshSpider() { spider.update(allMarkers); }
            map.on("zoomend moveend", refreshSpider);

            function setBase(mode) {
              currentBase = mode;
              document.documentElement.setAttribute("data-base", mode);
              document.body.setAttribute("data-base", mode);

              if (map.hasLayer(dark)) map.removeLayer(dark);
              if (map.hasLayer(light)) map.removeLayer(light);

              if (mode === "light") {
                light.addTo(map);
              } else {
                dark.addTo(map);
              }

              for (var i = 0; i < listData.length; i++) buildOrUpdateMarker(listData[i]);
              refreshSpider();
            }

            var baseSel = $("baseStyle");
            if (baseSel) baseSel.addEventListener("change", function () { setBase(baseSel.value); });

            function updateCounts() {
              var total = listData.length;
              var done = 0;
              for (var i = 0; i < listData.length; i++) if (listData[i].climbed) done++;
              setCount(done, total);
            }

            function renderChecklist(filterText) {
              var q = (filterText || "").toLowerCase().trim();
              var byRange = {};

              for (var j = 0; j < listData.length; j++) {
                var it = listData[j];
                if (q && it.name.toLowerCase().indexOf(q) === -1) continue;
                var r = it.range || "Unknown Range";
                if (!byRange[r]) byRange[r] = [];
                byRange[r].push(it);
              }

              Object.keys(byRange).forEach(function (r) {
                byRange[r].sort(function (a, b) { return a.number - b.number; });
              });

              var col = {
                frontsangre: $("range_frontsangre"),
                mosquitosawatch: $("range_mosquitosawatch"),
                elksanjuan: $("range_elksanjuan"),
              };
              col.frontsangre.innerHTML = "";
              col.mosquitosawatch.innerHTML = "";
              col.elksanjuan.innerHTML = "";

              var ranges = Object.keys(byRange).sort(function (a, b) {
                var ga = columnGroupForRange(a);
                var gb = columnGroupForRange(b);
                if (ga !== gb) return ga.localeCompare(gb);
                return rangeSortKey(a) - rangeSortKey(b);
              });

              var pinSvg =
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' +
                  '<path d="M12 21s7-4.5 7-11a7 7 0 1 0-14 0c0 6.5 7 11 7 11z"></path>' +
                  '<circle cx="12" cy="10" r="2.5"></circle>' +
                '</svg>';

              function escAttr(s) {
                return String(s || "").replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
              }

              function rangeCardHtml(rangeName, items) {
                var header =
                  '<div class="mb-2 flex items-center justify-between">' +
                    '<div class="text-sm font-semibold text-zinc-100">' + rangeTitle(rangeName) + '</div>' +
                    '<div class="text-xs text-zinc-500">' + items.length + ' peaks</div>' +
                  '</div>';

                var rows = '<div class="grid gap-2">';
                for (var k = 0; k < items.length; k++) {
                  var it = items[k];
                  var checked = it.climbed;

                  var numPill =
                    '<span class="inline-flex h-7 min-w-[28px] items-center justify-center rounded-full ring-1 px-2 text-[11px] font-semibold tabular-nums ' +
                      (checked
                        ? 'bg-emerald-500/15 text-emerald-200 ring-emerald-400/30'
                        : 'bg-white/5 text-zinc-200 ring-white/10') +
                    '">' + it.number + "</span>";

                  rows +=
                    '<div data-id="' + it.idKey + '" class="peak-row group flex items-center gap-3 rounded-2xl border border-white/10 bg-black/20 px-3 py-2 hover:bg-white/5">' +
                      numPill +
                      '<div class="min-w-0 flex-1">' +
                        '<div class="peak-name-2line text-sm text-zinc-100" title="' + escAttr(it.name) + '">' + escAttr(it.name) + '</div>' +
                      '</div>' +
                      '<div class="text-[11px] text-zinc-400 tabular-nums">' + (it.elevation_ft ? (it.elevation_ft + " ft") : "") + '</div>' +
                      '<button data-fly="' + it.idKey + '" class="pin-btn ml-2 grid h-8 w-8 place-items-center rounded-xl border border-white/10 bg-white/5 text-zinc-100 hover:bg-white/10" aria-label="Fly to peak">' +
                        pinSvg +
                      '</button>' +
                    '</div>';
                }
                rows += "</div>";

                return '<div class="rounded-2xl border border-white/10 bg-black/10 p-3 w-full min-w-0 overflow-hidden">' + header + rows + "</div>";
              }

              for (var rIdx = 0; rIdx < ranges.length; rIdx++) {
                var rname = ranges[rIdx];
                var items = byRange[rname];
                var group = columnGroupForRange(rname);
                if (!col[group]) continue;
                col[group].insertAdjacentHTML("beforeend", rangeCardHtml(rname, items));
              }

              updateCounts();
            }

            document.body.addEventListener("click", function (e) {
              var t = e.target;

              var flyBtn = t && t.closest ? t.closest("button[data-fly]") : null;
              if (flyBtn) {
                e.preventDefault();
                e.stopPropagation();
                var id = flyBtn.getAttribute("data-fly");
                var it = null;
                for (var i = 0; i < listData.length; i++) {
                  if (listData[i].idKey === id) { it = listData[i]; break; }
                }
                if (!it) return;
                map.flyTo([it.lat, it.lon], Math.max(map.getZoom(), 10), { duration: 0.8 });
                var mk = markerById[it.idKey];
                if (mk) mk.openPopup();
                return;
              }

              var row = t && t.closest ? t.closest(".peak-row") : null;
              if (!row) return;

              var rid = row.getAttribute("data-id");
              if (!rid) return;

              var item = null;
              for (var j = 0; j < listData.length; j++) {
                if (listData[j].idKey === rid) { item = listData[j]; break; }
              }
              if (!item) return;

              item.climbed = !item.climbed;
              setClimbed(item.pk, item.climbed);
              buildOrUpdateMarker(item);

              renderChecklist($("peakSearch").value);
              refreshSpider();
            });

            var searchEl = $("peakSearch");
            if (searchEl) searchEl.addEventListener("input", function () { renderChecklist(searchEl.value); });

            $("exportBtn").addEventListener("click", function () {
              var payload = { climbed: state.climbed };
              var blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
              var url = URL.createObjectURL(blob);
              var a = document.createElement("a");
              a.href = url;
              a.download = "my14ers.json";
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
            });

            $("importFile").addEventListener("change", function (ev) {
              var file = ev.target.files && ev.target.files[0];
              if (!file) return;
              var reader = new FileReader();
              reader.onload = function () {
                try {
                  var obj = JSON.parse(String(reader.result || "{}"));
                  if (obj && obj.climbed && typeof obj.climbed === "object") {
                    state.climbed = obj.climbed;
                    saveState(state);

                    for (var i = 0; i < listData.length; i++) {
                      listData[i].climbed = !!state.climbed[listData[i].idKey];
                      buildOrUpdateMarker(listData[i]);
                    }
                    renderChecklist($("peakSearch").value);
                    refreshSpider();
                  }
                } catch (e) {}
              };
              reader.readAsText(file);
              ev.target.value = "";
            });

            var exportSnapshotBtn = $("exportSnapshotBtn");
            if (exportSnapshotBtn) {
              exportSnapshotBtn.addEventListener("click", function () {
                exportSnapshot(exportSnapshotBtn);
              });
            }

            $("clearBtn").addEventListener("click", function () {
              state.climbed = {};
              saveState(state);

              for (var i = 0; i < listData.length; i++) {
                listData[i].climbed = false;
                buildOrUpdateMarker(listData[i]);
              }
              renderChecklist($("peakSearch").value);
              refreshSpider();
            });

            setBase("dark");
            renderChecklist("");
            refreshSpider();
            setStatus("Ready");

            async function exportSnapshot(button) {
              if (!button || isExportingSnapshot) return;
              isExportingSnapshot = true;
              button.disabled = true;
              button.classList.add("opacity-60");
              button.setAttribute("aria-busy", "true");

              var total = listData.length;
              var done = 0;
              for (var i = 0; i < total; i++) if (listData[i].climbed) done++;

              var view;
              if (bounds.length) {
                var b = window.L.latLngBounds(bounds);
                view = getStaticView(b, 780);
              } else {
                view = { center: map.getCenter(), zoom: map.getZoom() };
              }

              try {
                await exportPNG43(view, done, total);
              } catch (err) {
                console.error("[exportSnapshot] failed:", err);
                alert("Export failed; see console for details.");
              } finally {
                button.disabled = false;
                button.classList.remove("opacity-60");
                button.removeAttribute("aria-busy");
                isExportingSnapshot = false;
              }
            }

            async function exportPNG43(exportView, done, total) {
              var W = 1600, H = 1200;
              var PAD = 72;
              var GAP = 36;

              var mapSize = 780;

            var headerH = 140;
            var mapX = PAD;
            var mapY = headerH + 44;

              var panelX = mapX + mapSize + GAP;
              var panelY = mapY;
              var panelW = W - PAD - panelX;
              var panelH = mapSize;

              var center = exportView.center;
              var zoom = exportView.zoom;

              var staticUrl =
                "https://api.mapbox.com/styles/v1/" + mapboxStyleForBase(currentBase) + "/static/" +
                center.lng + "," + center.lat + "," + zoom + ",0/" +
                mapSize + "x" + mapSize +
                "?access_token=" + MAPBOX_TOKEN +
                "&logo=false&attribution=false";
              var mapSource = await loadImage(staticUrl);

              var canvas = document.createElement("canvas");
              canvas.width = W;
              canvas.height = H;
              var ctx = canvas.getContext("2d");

              var isLightBase = currentBase === "light";
              var pageBg = isLightBase ? "rgb(244,245,252)" : "rgb(9,9,11)";
              ctx.fillStyle = pageBg;
              ctx.fillRect(0, 0, W, H);

              var grd = ctx.createRadialGradient(W*0.28, H*0.15, 10, W*0.28, H*0.15, W*0.9);
              if (isLightBase) {
                grd.addColorStop(0, "rgba(255,255,255,0.9)");
                grd.addColorStop(0.5, "rgba(145,158,171,0.18)");
                grd.addColorStop(1, "rgba(226,232,240,0)");
              } else {
                grd.addColorStop(0, "rgba(168,85,247,0.18)");
                grd.addColorStop(0.55, "rgba(34,211,238,0.10)");
                grd.addColorStop(1, "rgba(0,0,0,0)");
              }
              ctx.fillStyle = grd;
              ctx.fillRect(0, 0, W, H);

              var titleColor = isLightBase ? "rgba(17,24,39,0.95)" : "rgba(244,244,245,0.96)";
            ctx.fillStyle = titleColor;
            ctx.font = "800 64px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
            ctx.textAlign = "center";
            ctx.fillText("Colorado 14ers", W / 2, 98);
            ctx.textAlign = "left";

              var pillText = done + " / " + total + " climbed";
              ctx.font = "700 20px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
              var pillW = Math.ceil(ctx.measureText(pillText).width) + 30;
              var pillH = 40;
              var pillX = W - PAD - pillW;
              var pillY = 96;

              ctx.fillStyle = isLightBase ? "rgba(17,24,39,0.08)" : "rgba(255,255,255,0.06)";
              roundRect(ctx, pillX, pillY, pillW, pillH, 999, true, false);
              ctx.strokeStyle = isLightBase ? "rgba(15,23,42,0.2)" : "rgba(255,255,255,0.12)";
              ctx.lineWidth = 1;
              roundRect(ctx, pillX, pillY, pillW, pillH, 999, false, true);

              ctx.fillStyle = titleColor;
              ctx.fillText(pillText, pillX + 15, pillY + 26);

              var mapCardFill = isLightBase ? "rgba(255,255,255,0.95)" : "rgba(0,0,0,0.20)";
              var mapCardBorder = isLightBase ? "rgba(15,23,42,0.2)" : "rgba(255,255,255,0.1)";
              ctx.fillStyle = mapCardFill;
              drawCard(ctx, mapX, mapY, mapSize, mapSize, 26);
              ctx.strokeStyle = mapCardBorder;
              ctx.lineWidth = 1;
              roundRect(ctx, mapX, mapY, mapSize, mapSize, 26, false, true);
              ctx.save();
              clipRoundRect(ctx, mapX, mapY, mapSize, mapSize, 26);
              ctx.drawImage(mapSource, mapX, mapY, mapSize, mapSize);
              ctx.restore();

              var crs = map.options.crs;
              var z = zoom;
              var centerPoint = crs.latLngToPoint(center, z);
              var topLeft = window.L.point(centerPoint.x - mapSize / 2, centerPoint.y - mapSize / 2);

              var pts = [];
              for (var i = 0; i < listData.length; i++) {
                var it = listData[i];
                var ll = window.L.latLng(it.lat, it.lon);
                var p = crs.latLngToPoint(ll, z);
                pts.push({
                  it: it,
                  ox: p.x - topLeft.x,
                  oy: p.y - topLeft.y,
                  x:  p.x - topLeft.x,
                  y:  p.y - topLeft.y
                });
              }
              spiderPixels(pts, 20, 22, 0.10, 0.60, 34);

              ctx.save();
              clipRoundRect(ctx, mapX, mapY, mapSize, mapSize, 26);

              ctx.strokeStyle = isLightBase ? "rgba(25,25,25,0.18)" : "rgba(255,255,255,0.26)";
              ctx.lineWidth = 1;
              for (var li = 0; li < pts.length; li++) {
                var p0x = mapX + pts[li].ox;
                var p0y = mapY + pts[li].oy;
                var p1x = mapX + pts[li].x;
                var p1y = mapY + pts[li].y;
                if (Math.abs(p1x - p0x) < 0.2 && Math.abs(p1y - p0y) < 0.2) continue;
                ctx.beginPath();
                ctx.moveTo(p0x, p0y);
                ctx.lineTo(p1x, p1y);
                ctx.stroke();
              }

              for (var mi = 0; mi < pts.length; mi++) {
                drawMarker(ctx, mapX + pts[mi].x, mapY + pts[mi].y, pts[mi].it.number, pts[mi].it.climbed, 1.0);
              }

              var creditColor = (currentBase === "light") ? "rgba(28,28,30,0.75)" : "rgba(244,244,245,0.70)";
              ctx.fillStyle = creditColor;
              ctx.font = "600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
              ctx.textAlign = "left";
              ctx.textBaseline = "alphabetic";
              ctx.fillText("© Mapbox © OpenStreetMap", mapX + 18, mapY + mapSize - 16);

              ctx.restore();

              var panelFill = isLightBase ? "rgba(255,255,255,0.95)" : "rgba(0,0,0,0.40)";
              var panelStroke = isLightBase ? "rgba(15,23,42,0.25)" : "rgba(255,255,255,0.10)";
              ctx.fillStyle = panelFill;
              drawCard(ctx, panelX, panelY, panelW, panelH, 26);
              ctx.strokeStyle = panelStroke;
              ctx.lineWidth = 1.2;
              roundRect(ctx, panelX, panelY, panelW, panelH, 26, false, true);

              ctx.fillStyle = isLightBase ? "rgba(17,24,39,0.9)" : "rgba(244,244,245,0.92)";
              ctx.font = "800 24px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
              ctx.textAlign = "center";
              ctx.fillText("Checklist", panelX + panelW / 2, panelY + 38);
              ctx.textAlign = "left";

              var colDefs = [
                { group: "frontsangre", sections: ["Front Range", "Sangre de Cristo Range"] },
                { group: "mosquitosawatch", sections: ["Mosquito Range", "Sawatch Range"] },
                { group: "elksanjuan", sections: ["Elk Mountains", "San Juan Mountains"] },
              ];

              var cols = {
                frontsangre: { "Front Range": [], "Sangre de Cristo Range": [] },
                mosquitosawatch: { "Mosquito Range": [], "Sawatch Range": [] },
                elksanjuan: { "Elk Mountains": [], "San Juan Mountains": [] },
              };

              for (var bi = 0; bi < listData.length; bi++) {
                var itB = listData[bi];
                var col = columnGroupForRange(itB.range);
                if (!cols[col]) col = "mosquitosawatch";
                var rk = rangeKey(itB.range);
                if (cols[col][rk] === undefined) {
                  rk = colDefs.find(function (d) { return d.group === col; }).sections[0];
                }
                cols[col][rk].push(itB);
              }

              Object.keys(cols).forEach(function (k) {
                Object.keys(cols[k]).forEach(function (s) {
                  cols[k][s].sort(function (a, b) { return a.number - b.number; });
                });
              });

              var innerPad = 18;
              var colGap = 12;
              var baseColW = Math.floor((panelW - innerPad*2 - colGap*2) / 3);
              var colW = Math.max(140, Math.floor(baseColW * 0.92));
              var totalTableW = colW * 3 + colGap * 2;
              var startX = panelX + innerPad + Math.floor((panelW - innerPad*2 - totalTableW) / 2);
              var startY = panelY + 72;

              for (var c = 0; c < colDefs.length; c++) {
                var def = colDefs[c];
                var cx = startX + c*(colW + colGap);
                var cy = startY;

                for (var si = 0; si < def.sections.length; si++) {
                  var sec = def.sections[si];
                  var items = cols[def.group][sec] || [];
                  if (!items.length) continue;

                  ctx.fillStyle = isLightBase ? "rgba(17,24,39,0.88)" : "rgba(244,244,245,0.92)";
                  ctx.font = "800 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
                  ctx.fillText(sec, cx, cy + 14);
                  cy += 22;

                  var tileH = 26;
                  var rowH = tileH + 4;

                  for (var ri = 0; ri < items.length; ri++) {
                    var itR = items[ri];

                    ctx.fillStyle = isLightBase ? "rgba(13,18,35,0.16)" : "rgba(0,0,0,0.18)";
                    roundRect(ctx, cx, cy, colW, tileH, 12, true, false);
                    ctx.strokeStyle = isLightBase ? "rgba(255,255,255,0.20)" : "rgba(255,255,255,0.10)";
                    ctx.lineWidth = 1;
                    roundRect(ctx, cx, cy, colW, tileH, 12, false, true);

                    var centerY = cy + tileH / 2;
                    drawMiniNum(ctx, cx + 12, centerY, itR.number, itR.climbed, 9, currentBase);

                    var nm = shortName(itR.name);
                    var rowTextColor = isLightBase
                      ? (itR.climbed ? "rgba(0,99,92,0.95)" : "rgba(15,23,42,0.9)")
                      : (itR.climbed ? "rgba(200,255,248,0.96)" : "rgba(244,244,245,0.90)");
                    ctx.fillStyle = rowTextColor;
                    ctx.font = "700 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
                    ctx.textBaseline = "middle";
                    ctx.fillText(ellipsis(ctx, nm, colW - 44), cx + 30, centerY);
                    ctx.textBaseline = "alphabetic";

                    cy += rowH;
                    if (cy > panelY + panelH - 24) break;
                  }

                  cy += 6;
                  if (cy > panelY + panelH - 24) break;
                }
              }

              downloadDataUrl(canvas.toDataURL("image/png"), "my14ers-snapshot-4x3.png");
            }

            function downloadDataUrl(dataUrl, filename) {
              var a = document.createElement("a");
              a.href = dataUrl;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              a.remove();
            }

            function rangeKey(r) {
              r = (r || "").toLowerCase();
              if (r.indexOf("front") !== -1) return "Front Range";
              if (r.indexOf("sangre") !== -1) return "Sangre de Cristo Range";
              if (r.indexOf("mosquito") !== -1) return "Mosquito Range";
              if (r.indexOf("sawatch") !== -1) return "Sawatch Range";
              if (r.indexOf("elk") !== -1) return "Elk Mountains";
              if (r.indexOf("san juan") !== -1) return "San Juan Mountains";
              return "Other";
            }

            function loadImage(src) {
              return new Promise(function (resolve, reject) {
                var img = new Image();
                img.crossOrigin = "anonymous";
                img.referrerPolicy = "no-referrer";
                img.onload = function () { resolve(img); };
                img.onerror = function () { reject(new Error("Failed to load image: " + src)); };
                img.src = src;
              });
            }

            function ellipsis(ctx, text, maxW) {
              if (ctx.measureText(text).width <= maxW) return text;
              var t = text;
              while (t.length > 3 && ctx.measureText(t + "…").width > maxW) t = t.slice(0, -1);
              return t + "…";
            }

            function shortName(name) {
              var s = String(name || "Unknown");
              s = s.replace(/^Mount\s+/i, "Mt. ");
              s = s.replace(/^Mt\s+/i, "Mt. ");
              s = s.replace(/\s+Mountain$/i, " Mtn.");
              s = s.replace(/\s+Peak$/i, " Peak");
              s = s.replace(/\s+Point$/i, " Pt.");
              return s;
            }

            function drawCard(ctx, x, y, w, h, r) {
              ctx.fillStyle = "rgba(255,255,255,0.05)";
              roundRect(ctx, x, y, w, h, r, true, false);
              ctx.strokeStyle = "rgba(255,255,255,0.10)";
              ctx.lineWidth = 1;
              roundRect(ctx, x, y, w, h, r, false, true);
            }

            function drawMiniNum(ctx, cx, cy, number, climbed, r, base) {
              base = base || "dark";
              ctx.save();
              ctx.beginPath();
              ctx.arc(cx, cy, r, 0, Math.PI*2);
              if (climbed) {
                if (base === "light") {
                  ctx.fillStyle = "rgba(0,163,105,0.20)";
                  ctx.fill();
                  ctx.strokeStyle = "rgba(0,0,0,0.95)";
                  ctx.lineWidth = 2;
                  ctx.stroke();
                  ctx.fillStyle = "rgba(245,255,248,0.96)";
                } else {
                  ctx.fillStyle = "rgba(0,255,213,0.20)";
                  ctx.fill();
                  ctx.strokeStyle = "rgba(0,255,213,0.40)";
                  ctx.lineWidth = 2;
                  ctx.stroke();
                  ctx.fillStyle = "rgba(200,255,248,0.96)";
                }
              } else {
                if (base === "light") {
                  ctx.fillStyle = "rgba(5,5,5,0.85)";
                  ctx.fill();
                  ctx.strokeStyle = "rgba(0,0,0,0.95)";
                  ctx.lineWidth = 2;
                  ctx.stroke();
                  ctx.fillStyle = "rgba(244,244,245,0.92)";
                } else {
                  ctx.fillStyle = "rgba(0,0,0,0.28)";
                  ctx.fill();
                  ctx.strokeStyle = "rgba(226,232,240,0.70)";
                  ctx.lineWidth = 2;
                  ctx.stroke();
                  ctx.fillStyle = "rgba(244,244,245,0.92)";
                }
              }
              ctx.font = "900 11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText(String(number), cx, cy + 0.5);
              ctx.restore();
            }

            function drawMarker(ctx, x, y, number, climbed, scale) {
              var r = 11 * scale;
              var strokeW = 1.4 * scale;

              ctx.save();
              ctx.beginPath();
              ctx.arc(x, y, r, 0, Math.PI*2);

              if (climbed) {
                if (currentBase === "light") {
                  ctx.fillStyle = "rgba(0,163,105,0.95)";
                  ctx.fill();
                  ctx.lineWidth = strokeW;
                  ctx.strokeStyle = "rgba(0,0,0,0.95)";
                  ctx.stroke();
                  ctx.shadowColor = "rgba(0,0,0,0.25)";
                  ctx.shadowBlur = 10 * scale;
                  ctx.beginPath();
                  ctx.arc(x, y, r, 0, Math.PI*2);
                  ctx.stroke();
                  ctx.shadowBlur = 0;
                  ctx.fillStyle = "rgba(255,255,255,0.92)";
                } else {
                  ctx.fillStyle = "rgba(0,255,213,0.95)";
                  ctx.fill();
                  ctx.lineWidth = strokeW;
                  ctx.strokeStyle = "rgba(255,255,255,0.95)";
                  ctx.stroke();

                  ctx.shadowColor = "rgba(0,255,213,0.30)";
                  ctx.shadowBlur = 10 * scale;
                  ctx.beginPath();
                  ctx.arc(x, y, r, 0, Math.PI*2);
                  ctx.stroke();
                  ctx.shadowBlur = 0;

                  ctx.fillStyle = "rgba(0,0,0,0.92)";
                }
              } else {
                if (currentBase === "light") {
                  ctx.fillStyle = "rgba(10,10,10,0.80)";
                  ctx.fill();
                  ctx.lineWidth = strokeW;
                  ctx.strokeStyle = "rgba(0,0,0,0.95)";
                  ctx.stroke();
                  ctx.fillStyle = "rgba(244,244,245,0.92)";
                } else {
                  ctx.fillStyle = "rgba(0,0,0,0.28)";
                  ctx.fill();
                  ctx.lineWidth = strokeW;
                  ctx.strokeStyle = "rgba(226,232,240,0.80)";
                  ctx.stroke();
                  ctx.fillStyle = "rgba(244,244,245,0.92)";
                }
              }

              ctx.font = (10 * scale) + "px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText(String(number), x, y + (0.2 * scale));
              ctx.restore();
            }

            function roundRect(ctx, x, y, w, h, r, fill, stroke) {
              if (r > h/2) r = h/2;
              if (r > w/2) r = w/2;
              ctx.beginPath();
              ctx.moveTo(x + r, y);
              ctx.arcTo(x + w, y, x + w, y + h, r);
              ctx.arcTo(x + w, y + h, x, y + h, r);
              ctx.arcTo(x, y + h, x, y, r);
              ctx.arcTo(x, y, x + w, y, r);
              ctx.closePath();
              if (fill) ctx.fill();
              if (stroke) ctx.stroke();
            }

            function clipRoundRect(ctx, x, y, w, h, r) {
              if (r > h/2) r = h/2;
              if (r > w/2) r = w/2;
              ctx.beginPath();
              ctx.moveTo(x + r, y);
              ctx.arcTo(x + w, y, x + w, y + h, r);
              ctx.arcTo(x + w, y + h, x, y + h, r);
              ctx.arcTo(x, y + h, x, y, r);
              ctx.arcTo(x, y, x + w, y, r);
              ctx.closePath();
              ctx.clip();
            }

            function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }

            function latLngToWorldPx(lat, lon, z) {
              var sin = Math.sin(lat * Math.PI / 180);
              sin = clamp(sin, -0.9999, 0.9999);
              var scale = 256 * Math.pow(2, z);
              var x = (lon + 180) / 360 * scale;
              var y = (0.5 - Math.log((1 + sin) / (1 - sin)) / (4 * Math.PI)) * scale;
              return { x: x, y: y };
            }

            function getFitZoomForBounds(bounds, w, h, padPx) {
              var padding = padPx || 0;
              var W = Math.max(1, w - 2 * padding);
              var H = Math.max(1, h - 2 * padding);

              var sw = bounds.getSouthWest();
              var ne = bounds.getNorthEast();

              for (var z = 14; z >= 4; z--) {
                var a = latLngToWorldPx(sw.lat, sw.lng, z);
                var b = latLngToWorldPx(ne.lat, ne.lng, z);
                var dx = Math.abs(b.x - a.x);
                var dy = Math.abs(b.y - a.y);
                if (dx <= W && dy <= H) return z;
              }
              return 4;
            }

            function getStaticView(bounds, sizePx) {
              var pad = 26;
              var z = getFitZoomForBounds(bounds, sizePx, sizePx, pad);
              z = Math.min(z + 1, 12);
              var c = bounds.getCenter();
              return { center: c, zoom: z };
            }

            function spiderPixels(points, minDist, ITER, spring, repel, maxDisp) {
              function connectedComponents(nodes, minDist) {
                var n = nodes.length;
                var parent = new Array(n);
                for (var i = 0; i < n; i++) parent[i] = i;

                function find(x) {
                  while (parent[x] !== x) {
                    parent[x] = parent[parent[x]];
                    x = parent[x];
                  }
                  return x;
                }
                function union(a, b) {
                  var ra = find(a), rb = find(b);
                  if (ra !== rb) parent[rb] = ra;
                }

                var min2 = minDist * minDist;
                for (var a = 0; a < n; a++) {
                  for (var b = a + 1; b < n; b++) {
                    var dx = nodes[b].ox - nodes[a].ox;
                    var dy = nodes[b].oy - nodes[a].oy;
                    if (dx*dx + dy*dy < min2) union(a, b);
                  }
                }

                var groups = {};
                for (var k = 0; k < n; k++) {
                  var r = find(k);
                  if (!groups[r]) groups[r] = [];
                  groups[r].push(nodes[k]);
                }
                return Object.values(groups);
              }

              var comps = connectedComponents(points, minDist);
              var min2 = minDist * minDist;

              for (var c = 0; c < comps.length; c++) {
                var comp = comps[c];
                if (comp.length <= 1) {
                  comp[0].x = comp[0].ox;
                  comp[0].y = comp[0].oy;
                  continue;
                }

                for (var ii = 0; ii < comp.length; ii++) {
                  comp[ii].x = comp[ii].ox;
                  comp[ii].y = comp[ii].oy;
                }

                for (var it = 0; it < ITER; it++) {
                  for (var s = 0; s < comp.length; s++) {
                    comp[s].x += (comp[s].ox - comp[s].x) * spring;
                    comp[s].y += (comp[s].oy - comp[s].y) * spring;
                  }

                  for (var a = 0; a < comp.length; a++) {
                    for (var b = a + 1; b < comp.length; b++) {
                      var dx = comp[b].x - comp[a].x;
                      var dy = comp[b].y - comp[a].y;
                      var d2 = dx*dx + dy*dy;

                      if (d2 < 0.0001) {
                        dx = (Math.random() - 0.5) * 0.2;
                        dy = (Math.random() - 0.5) * 0.2;
                        d2 = dx*dx + dy*dy;
                      }

                      if (d2 < min2) {
                        var d = Math.sqrt(d2);
                        var push = (minDist - d) * repel;
                        var ux = dx / d;
                        var uy = dy / d;

                        comp[a].x -= ux * push * 0.5;
                        comp[a].y -= uy * push * 0.5;
                        comp[b].x += ux * push * 0.5;
                        comp[b].y += uy * push * 0.5;
                      }
                    }
                  }

                  for (var k = 0; k < comp.length; k++) {
                    var ddx = comp[k].x - comp[k].ox;
                    var ddy = comp[k].y - comp[k].oy;
                    var dist = Math.sqrt(ddx*ddx + ddy*ddy);
                    if (dist > maxDisp) {
                      comp[k].x = comp[k].ox + (ddx/dist) * maxDisp;
                      comp[k].y = comp[k].oy + (ddy/dist) * maxDisp;
                    }
                  }
                }
              }
            }
          })
          .catch(function (err) {
            console.error(err);
            setStatus("Failed to load peaks.");
          });
      });
    })();
  </script>
</section>